<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Eudes Chat Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --eudes-blue: #0056b3; --white: #ffffff; --bg: #f4f7f9; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #e5ddd5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header with Brand Colors */
        .header { background: var(--eudes-blue); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; height: 65px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .header-icons { display: flex; gap: 18px; }
        .header-icons i { font-size: 1.3rem; cursor: pointer; padding: 5px; }

        /* Profile Pic Circle */
        .avatar { width: 42px; height: 42px; border-radius: 50%; background: #fff; color: var(--eudes-blue); display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden; border: 2px solid rgba(255,255,255,0.4); cursor: pointer; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* Chat Area */
        #chatbox { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; }
        .msg-row.sent { flex-direction: row-reverse; }
        .bubble { padding: 12px 16px; border-radius: 18px; max-width: 75%; font-size: 16px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent .bubble { background: var(--eudes-blue); color: white; border-bottom-right-radius: 2px; }
        .received .bubble { background: var(--white); color: #333; border-bottom-left-radius: 2px; }

        /* Fixed Bottom Bar for Keyboard Fix */
        .input-bar { background: #f0f2f5; padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #msgInput { flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid #ccc; font-size: 16px; outline: none; background: #fff; }
        
        /* High-Response Send Button */
        .send-btn { background: var(--eudes-blue); color: white; width: 46px; height: 46px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; flex-shrink: 0; }
        
        #fileInput { display: none; }
        .support-text { text-align: center; font-size: 10px; color: #777; background: #f0f2f5; padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <div class="avatar" id="mainAvatar" onclick="openFile()">E</div>
        <div style="line-height: 1.2;">
            <div style="font-size: 14px; font-weight: bold;">EUDES MEDIA</div>
            <div style="font-size: 10px; opacity: 0.9;">Online</div>
        </div>
    </div>
    <div class="header-icons">
        <i class="fas fa-phone" onclick="startCall('Audio')"></i>
        <i class="fas fa-video" onclick="startCall('Video')"></i>
        <i class="fas fa-sign-out-alt" onclick="handleLogout()"></i>
    </div>
</div>

<div id="chatbox"></div>

<div class="input-bar">
    <i class="fas fa-camera" style="color:var(--eudes-blue); font-size:1.5rem; cursor:pointer;" onclick="openFile()"></i>
    <input type="text" id="msgInput" placeholder="Type message..." autocomplete="off">
    <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
</div>
<div class="support-text">Eudes Media Support: +256762992440</div>

<input type="file" id="fileInput" accept="image/*" onchange="uploadProfilePic(this)">

<script>
    const S_URL = "https://kjftrwuucjdnhfwesrup.supabase.co";
    const S_KEY = "sb_publishable_1PetUo8klWCLfupRq52CVg_Y_YYrzcO";
    const sb = supabase.createClient(S_URL, S_KEY);

    let user = null;
    let currentAvatar = null;

    async function init() {
        const { data } = await sb.auth.getSession();
        if (!data.session) return;
        user = data.session.user;
        
        // Pull saved avatar from metadata
        currentAvatar = user.user_metadata.avatar_url;
        refreshProfile();
        loadMessages();
        listenForNewMessages();
    }

    function refreshProfile() {
        const av = document.getElementById('mainAvatar');
        if (currentAvatar) {
            av.innerHTML = `<img src="${currentAvatar}">`;
        } else {
            av.innerText = user.email[0].toUpperCase();
        }
    }

    function openFile() { document.getElementById('fileInput').click(); }

    async function uploadProfilePic(input) {
        if (!input.files || input.files.length === 0) return;
        const file = input.files[0];
        const fileExt = file.name.split('.').pop();
        const path = `user_${user.id}_${Date.now()}.${fileExt}`;

        // Upload to Storage
        const { error: uploadError } = await sb.storage.from('avatars').upload(path, file);
        if (uploadError) return alert("Upload Error: " + uploadError.message);

        // Get URL
        const { data } = sb.storage.from('avatars').getPublicUrl(path);
        currentAvatar = data.publicUrl;

        // Save to user profile
        await sb.auth.updateUser({ data: { avatar_url: currentAvatar } });
        
        refreshProfile();
        alert("Profile Picture Updated!");
    }

    async function sendMsg() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if (!text) return;

        const { error } = await sb.from('messages').insert([{ 
            text: text, 
            user_id: user.id, 
            user_name: "Prince Eudes",
            avatar_url: currentAvatar 
        }]);
        
        if (error) {
            alert("Send Error: Make sure your Database Policies are set to INSERT!");
        } else {
            input.value = '';
            input.focus();
        }
    }

    async function loadMessages() {
        const { data } = await sb.from('messages').select('*').order('created_at', { ascending: true });
        if (data) {
            const chatbox = document.getElementById('chatbox');
            chatbox.innerHTML = '';
            data.forEach(msg => {
                const isMe = msg.user_id === user.id;
                chatbox.innerHTML += `
                    <div class="msg-row ${isMe ? 'sent' : 'received'}">
                        <div class="avatar" style="width:30px; height:30px; font-size:11px;">
                            ${msg.avatar_url ? `<img src="${msg.avatar_url}">` : (msg.user_name || 'U')[0].toUpperCase()}
                        </div>
                        <div class="bubble">${msg.text}</div>
                    </div>
                `;
            });
            chatbox.scrollTop = chatbox.scrollHeight;
        }
    }

    function listenForNewMessages() {
        sb.channel('custom-all-channel').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, loadMessages).subscribe();
    }

    function startCall(type) {
        const room = "EudesMedia_" + Math.floor(Math.random() * 10000);
        window.open(`https://meet.jit.si/${room}#config.startWithVideoMuted=${type==='Audio'}`, '_blank');
    }

    async function handleLogout() {
        await sb.auth.signOut();
        window.location.reload();
    }

    document.getElementById('msgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMsg(); });

    init();
</script>
</body>
</html>
