<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eudes Media Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 40px 20px; }
        .card { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .header { color: #007bff; font-weight: bold; font-size: 22px; margin-bottom: 20px; }
        #messages { height: 300px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 15px; padding: 10px; text-align: left; background: #fafafa; border-radius: 8px; }
        .msg { margin-bottom: 12px; padding: 8px; background: #fff; border: 1px solid #eee; border-radius: 6px; font-size: 14px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button.alt { background: #007bff; margin-top: 10px; }
        .hidden { display: none; }
        .footer { margin-top: 30px; font-size: 13px; color: #888; line-height: 1.5; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">EUDES MEDIA COMMUNITY</div>

    <div id="step1">
        <p>Enter your email to get a login code</p>
        <input type="email" id="email" placeholder="email@gmail.com">
        <button onclick="sendOTP()">Send Code</button>
    </div>

    <div id="step2" class="hidden">
        <p>Enter the 6-digit code from your email</p>
        <input type="text" id="otp" placeholder="123456">
        <button class="alt" onclick="verifyOTP()">Verify & Enter Chat</button>
    </div>

    <div id="step3" class="hidden">
        <div id="messages"></div>
        <input type="text" id="msgInput" placeholder="Write a message...">
        <button onclick="sendMsg()">Send</button>
        <button class="alt" style="background:#6c757d" onclick="location.reload()">Sign Out</button>
    </div>
</div>

<div class="footer">
    <strong>Eudes Media</strong><br>
    Contact: +256762992440
</div>

<script>
    const S_URL = "YOUR_SUPABASE_URL";
    const S_KEY = "YOUR_SUPABASE_ANON_KEY";
    const sb = supabase.createClient(S_URL, S_KEY);

    // Auto-login check
    async function checkUser() {
        const { data: { user } } = await sb.auth.getUser();
        if (user) showChat();
    }
    checkUser();

    async function sendOTP() {
        const email = document.getElementById('email').value;
        const { error } = await sb.auth.signInWithOtp({ email });
        if (error) alert(error.message);
        else {
            alert("Code sent! Check your Gmail.");
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }
    }

    async function verifyOTP() {
        const email = document.getElementById('email').value;
        const token = document.getElementById('otp').value;
        const { error } = await sb.auth.verifyOtp({ email, token, type: 'email' });
        if (error) alert("Incorrect code. Try again.");
        else showChat();
    }

    function showChat() {
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.remove('hidden');
        loadMsgs();
        // Realtime refresh
        sb.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'Message' }, loadMsgs).subscribe();
    }

    async function loadMsgs() {
        const { data } = await sb.from('Message').select('*').order('created_at', { ascending: true });
        if (data) {
            document.getElementById('messages').innerHTML = data.map(m => `<div class="msg"><b>${m.username.split('@')[0]}</b>: ${m.content}</div>`).join('');
            const box = document.getElementById('messages'); box.scrollTop = box.scrollHeight;
        }
    }

    async function sendMsg() {
        const { data: { user } } = await sb.auth.getUser();
        const content = document.getElementById('msgInput').value;
        if (content && user) {
            await sb.from('Message').insert([{ username: user.email, content: content }]);
            document.getElementById('msgInput').value = '';
        }
    }
</script>

</body>
</html>
