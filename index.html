<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Eudes Chat Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --eudes-blue: #0056b3; --white: #ffffff; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }
        
        /* Header & Navigation */
        .header { background: var(--eudes-blue); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .actions i { margin-left: 20px; cursor: pointer; font-size: 1.2rem; transition: 0.3s; }
        .actions i:hover { color: #ccc; }

        /* Chat Area */
        #chatbox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 12px; max-width: 75%; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { align-self: flex-end; background: var(--eudes-blue); color: white; }
        .received { align-self: flex-start; background: var(--white); color: #333; }

        /* Input Area with Media Buttons */
        .input-area { background: var(--white); padding: 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        .input-area input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ccc; outline: none; }
        .media-btn { color: var(--eudes-blue); font-size: 1.4rem; cursor: pointer; }
        
        /* Footer */
        .footer { font-size: 11px; text-align: center; color: #777; padding: 10px; background: #fff; }
    </style>
</head>
<body>

<div class="header">
    <span>EUDES CHAT PRO</span>
    <div class="actions">
        <i class="fas fa-phone" onclick="startCall('audio')"></i>
        <i class="fas fa-video" onclick="startCall('video')"></i>
        <i class="fas fa-sign-out-alt" onclick="logout()"></i>
    </div>
</div>

<div id="chatbox">
    <div class="msg received">Welcome to Eudes Media. How can we help you today?</div>
</div>

<div class="input-area">
    <i class="fas fa-microphone media-btn" onclick="startVoiceNote()"></i>
    <input type="text" id="msgInput" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMsg()">
    <i class="fas fa-paper-plane media-btn" onclick="sendMsg()"></i>
</div>

<div class="footer">Eudes Media Support: +256762992440</div>

<script>
    const S_URL = "https://kjftrwuucjdnhfwesrup.supabase.co";
    const S_KEY = "sb_publishable_1PetUo8klWCLfupRq52CVg_Y_YYrzcO";
    const sb = supabase.createClient(S_URL, S_KEY);

    let user = null;

    // Load Session
    async function init() {
        const { data } = await sb.auth.getSession();
        if (!data.session) return window.location.href = "index.html"; 
        user = data.session.user;
        loadMessages();
        subscribe();
    }

    async function sendMsg() {
        const input = document.getElementById('msgInput');
        if (!input.value.trim()) return;
        
        const { error } = await sb.from('messages').insert([
            { text: input.value, user_id: user.id, user_name: user.email.split('@')[0] }
        ]);
        
        if (!error) input.value = '';
    }

    async function loadMessages() {
        const { data } = await sb.from('messages').select('*').order('created_at', { ascending: true });
        if (data) {
            const chatbox = document.getElementById('chatbox');
            chatbox.innerHTML = '';
            data.forEach(msg => {
                const div = document.createElement('div');
                div.className = `msg ${msg.user_id === user.id ? 'sent' : 'received'}`;
                div.innerText = msg.text;
                chatbox.appendChild(div);
            });
            chatbox.scrollTop = chatbox.scrollHeight;
        }
    }

    function subscribe() {
        sb.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
            loadMessages();
        }).subscribe();
    }

    // Multimedia Functions
    function startCall(type) { alert("Starting " + type + " call... (Eudes Media Feature Active)"); }
    function startVoiceNote() { alert("Recording voice note..."); }
    async function logout() { await sb.auth.signOut(); location.reload(); }

    init();
</script>
</body>
</html>
