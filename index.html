<script>
const S_URL = "https://kjftrwuucjdnhfwesrup.supabase.co";
const S_KEY = "sb_publishable_1PetUo8klWCLfupRq52CVg_Y_YYrzcO";
const sb = supabase.createClient(S_URL, S_KEY);

let isLoginMode = true;
let isRecovery = false;

/* ðŸ”¥ IMPORTANT FIX */
window.addEventListener("load", async () => {
    const { data } = await sb.auth.getSession();
    
    if (window.location.hash.includes("type=recovery")) {
        isRecovery = true;
        activateRecoveryMode();
    }

    if (data.session && !isRecovery) {
        showChatUI();
    }
});

/* Detect auth changes */
sb.auth.onAuthStateChange((event, session) => {
    if (event === "PASSWORD_RECOVERY") {
        isRecovery = true;
        activateRecoveryMode();
    }
    if (event === "SIGNED_IN" && !isRecovery) {
        showChatUI();
    }
});

/* ðŸ”¹ Activate Reset Mode */
function activateRecoveryMode() {
    document.getElementById('auth-title').innerText = "SET NEW PASSWORD";
    document.getElementById('mainBtn').innerText = "SAVE NEW PASSWORD";
    document.getElementById('email').style.display = "none";
    document.getElementById('passConfirm').style.display = "block";
    document.getElementById('auth-options').style.display = "none";
    document.getElementById('reg-fields').style.display = "none";
}

/* ðŸ”¹ Show Chat */
function showChatUI() {
    document.getElementById('auth-ui').style.display = 'none';
    document.getElementById('chat-ui').style.display = 'flex';
}

/* Toggle login/register */
function toggleAuthMode() {
    if(isRecovery) return;
    isLoginMode = !isLoginMode;
    document.getElementById('auth-title').innerText = isLoginMode ? "LOG IN" : "REGISTER";
    document.getElementById('mainBtn').innerText = isLoginMode ? "LOG IN" : "CREATE ACCOUNT";
    document.getElementById('reg-fields').style.display = isLoginMode ? "none" : "block";
    document.getElementById('passConfirm').style.display = isLoginMode ? "none" : "block";
}

/* Handle Auth */
async function handleAuth() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    const passConfirm = document.getElementById('passConfirm').value;

    if (isRecovery) {
        if (pass !== passConfirm) return alert("Passwords do not match!");
        
        const { error } = await sb.auth.updateUser({ password: pass });
        if (error) alert(error.message);
        else {
            alert("Password updated successfully!");
            window.location.href = window.location.origin;
        }
    }

    else if (isLoginMode) {
        const { error } = await sb.auth.signInWithPassword({ email, password: pass });
        if (error) alert(error.message);
    }

    else {
        const name = document.getElementById('regName').value;
        const phone = document.getElementById('regPhone').value;
        if (phone.length !== 10) return alert("Phone must be exactly 10 digits!");

        const { error } = await sb.auth.signUp({
            email,
            password: pass,
            options: {
                emailRedirectTo: window.location.origin,
                data: { full_name: name, phone_number: phone }
            }
        });

        if (error) alert(error.message);
        else alert("Verify your email to continue!");
    }
}

/* Forgot Password */
async function handleForgotPassword() {
    const email = document.getElementById('email').value;
    if (!email) return alert("Please type your email address.");

    const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin
    });

    if (error) alert(error.message);
    else alert("Reset link sent to your email!");
}
</script>
